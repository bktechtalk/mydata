---
- name: Start "{{ application_name }}" playbook project deployment
  hosts: all
  vars_files:
    - "mydataUserInput.yaml"
  #vars:
  #  - appname: "{{ application_name }}"
  #  - appNameSpace: "{{ namespace_name }}"
  #  - imagetag: "{{ imageTagName }}"
  #  - version: "{{ version }}"

  tasks:
    - name: Build "{{ application_name }}" image and push to private image repository
      docker_image:
        path: mydockerfile
        name:  baruniitt06/dockerImage-{{ application_name }}
        tag: "{{ imageTagName }}"
        push: yes
      
    - name: Create NameSpace for "{{ application_name }}"
      k8s:
        name: "{{ namespace_name }}"
        api_version: v1
        kind: Namespace
        state: present
      #command: kubectl apply -f {{ application_name }}-web-namespace.yaml

    - name: Deploy "{{ application_name }}" service under the "{{ namespace_name }}"
      command: "{{ item }}"
      loop:
        - "kubectl apply -f {{ application_name }}-web-configmaps.yml"
        - "kubectl apply -f {{ application_name }}-web-deployment.yml"
        - "kubectl apply -f {{ application_name }}-web-services.yml"
        - "kubectl apply -f {{ application_name }}-web-ingress.yml"
      args:
        chdir: "{{ application_name }}-web"

    - name: Gather "{{ application_name }}" details and send email to "{{ application_name }}" app onwer
      command: "{{ item }}"
      with_items:
        - kubectl -n {{ appNameSpace }} get statefulsets
        - kubectl -n {{ appNameSpace }} get replicaset
        - kubectl -n {{ appNameSpace }} get pods
        - kubectl -n {{ appNameSpace }} get services
